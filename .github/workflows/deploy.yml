name: Deploy to Lightsail

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: NODE_OPTIONS=--max-old-space-size=2048 npm run build

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Add Lightsail host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to Lightsail
        run: |
          echo "DEBUG: SSH_HOST = ${{ secrets.SSH_HOST }}"
          echo "DEBUG: SSH_KEY exists = $([ -n '${{ secrets.SSH_KEY }}' ] && echo 'yes' || echo 'no')"
          
          # Clean and create remote directory
          ssh -i ~/.ssh/deploy_key ubuntu@${{ secrets.SSH_HOST }} "sudo rm -rf /home/ubuntu/tire-plan/dist && sudo mkdir -p /home/ubuntu/tire-plan"
          
          # Copy dist folder
          scp -i ~/.ssh/deploy_key -r dist ubuntu@${{ secrets.SSH_HOST }}:/home/ubuntu/tire-plan/
          
          # Set permissions
          ssh -i ~/.ssh/deploy_key ubuntu@${{ secrets.SSH_HOST }} "sudo chown -R www-data:www-data /home/ubuntu/tire-plan/dist"
          
          # Reload nginx
          ssh -i ~/.ssh/deploy_key ubuntu@${{ secrets.SSH_HOST }} "sudo systemctl reload nginx"
          
          echo "âœ… Deployment complete!"
