rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // 헬퍼 함수
    // ========================================
    
    // 인증된 사용자 확인
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // 소유자 확인 (Firebase Auth 기반)
    function isOwner(ownerId) {
      return isAuthenticated() && request.auth.uid == ownerId;
    }
    
    // SUPER_ADMIN 확인 (owners 컬렉션에서 role 조회)
    function isSuperAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/owners/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/owners/$(request.auth.uid)).data.role == 'SUPER_ADMIN';
    }
    
    // 데이터의 소유자이거나 SUPER_ADMIN인지 확인
    function isOwnerOrAdmin(ownerId) {
      return isOwner(ownerId) || isSuperAdmin();
    }

    // ========================================
    // Owners 컬렉션 (사용자 계정)
    // ========================================
    match /owners/{ownerId} {
      // ID 기반 로그인: 인증되지 않은 상태에서도 owner 정보 읽기 허용 (로그인 검증용)
      allow read: if true;
      
      // 새 계정 생성: 인증된 사용자이고 자신의 UID로 생성
      allow create: if isAuthenticated() && 
                       request.auth.uid == ownerId &&
                       request.resource.data.keys().hasAll(['id', 'name', 'role']);
      
      // 자신의 정보 수정 가능, SUPER_ADMIN은 모든 owner 수정 가능
      // 또는 개발 중 비밀번호 해시 마이그레이션을 위해 임시로 모든 쓰기 허용
      allow update: if true;
      
      // 삭제는 SUPER_ADMIN만 가능
      allow delete: if isSuperAdmin();
    }

    // ========================================
    // Stores 컬렉션 (매장 정보)
    // ========================================
    match /stores/{storeId} {
      allow read: if true;
      allow create, update, delete: if true;
    }

    // ========================================
    // Products 컬렉션 (제품/재고)
    // ========================================
    match /products/{productId} {
      allow read: if true;
      allow create, update, delete: if true;
    }

    // ========================================
    // Sales 컬렉션 (매출 기록)
    // ========================================
    match /sales/{saleId} {
      allow read: if true;
      allow create, update, delete: if true;
    }

    // ========================================
    // StockInHistory 컬렉션 (입고 기록)
    // ========================================
    match /stockInHistory/{stockId} {
      allow read: if true;
      allow create, update, delete: if true;
    }

    // ========================================
    // Customers 컬렉션 (고객 정보)
    // ========================================
    match /customers/{customerId} {
      allow read: if true;
      allow create, update, delete: if true;
    }

    // ========================================
    // Staff 컬렉션 (직원 정보)
    // ========================================
    match /staff/{staffId} {
      allow read: if true;
      allow create, update, delete: if true;
    }

    // ========================================
    // Expenses 컬렉션 (지출 기록)
    // ========================================
    match /expenses/{expenseId} {
      allow read: if true;
      allow create, update, delete: if true;
    }

    // ========================================
    // FixedCosts 컬렉션 (고정비용)
    // ========================================
    match /fixedCosts/{costId} {
      allow read: if true;
      allow create, update, delete: if true;
    }

    // ========================================
    // LeaveRequests 컬렉션 (휴가 신청)
    // ========================================
    match /leaveRequests/{requestId} {
      allow read: if true;
      allow create, update, delete: if true;
    }

    // ========================================
    // Reservations 컬렉션 (예약)
    // ========================================
    match /reservations/{reservationId} {
      allow read: if true;
      allow create, update, delete: if true;
    }

    // ========================================
    // StockTransfers 컬렉션 (재고 이동)
    // ========================================
    match /stockTransfers/{transferId} {
      allow read: if true;
      allow create, update, delete: if true;
    }

    // ========================================
    // Shifts 컬렉션 (근무표)
    // ========================================
    match /shifts/{shiftId} {
      allow read: if true;
      allow create, update, delete: if true;
    }

    // ========================================
    // Settings 컬렉션 (설정)
    // ========================================
    match /settings/{settingId} {
      allow read: if true;
      allow write: if true;
    }

    // ========================================
    // Subscriptions 컬렉션 (구독 정보)
    // ========================================
    match /subscriptions/{subscriptionId} {
      allow read: if true;
      allow write: if false;
    }

    // ========================================
    // BillingKeys 컬렉션 (결제 키)
    // ========================================
    match /billingKeys/{billingKeyId} {
      allow read: if true;
      allow write: if false;
    }

    // ========================================
    // PaymentHistory 컬렉션 (결제 내역)
    // ========================================
    match /paymentHistory/{paymentId} {
      allow read: if true;
      allow create: if false;
      allow update, delete: if false;
    }

    // ========================================
    // UsageMetrics 컬렉션 (사용량 메트릭)
    // ========================================
    match /usageMetrics/{metricId} {
      allow read: if true;
      allow write: if false;
    }

    // ========================================
    // 기본 규칙 (모든 기타 문서 차단)
    // ========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

